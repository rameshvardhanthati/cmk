"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("../../common/utils");
const StableIdHelper_1 = require("./StableIdHelper");
const common_1 = require("../../common");
/**
 * Processes a LineItem record of type DataFieldForCation during app schema generation
 * @param appSchema - the app specific schema that shall get enhanced
 * @param entityType - the entity type as part of the AVT ConverterOutput
 * @param actions - actions definition in schema, parent object
 * @param lineItemPath - annotation path to the line item
 * @param lineItemRecord - actual record of the line item collection
 * @param recordIndex - record index in the collection
 */
function handleActionRecord(appSchema, entityType, actions, lineItemPath, lineItemRecord, lineItemId, recordIndex) {
    // Action but not inline action
    if (lineItemRecord.Determining !== true) {
        //no footer bar -> toolbar action
        const actionDefinitionName = lineItemId === 'LineItems' ? 'ToolBarAction' : 'ObjectPageToolBarAction';
        const actionDefinition = common_1.prepareRef(`${actionDefinitionName}<${lineItemRecord.Action}>`);
        const description = utils_1.getDatafieldDescription(lineItemRecord, entityType);
        actions['properties'][`DataFieldForAction::${lineItemRecord.Action}`] = {
            $ref: utils_1.DEFINITION_LINK_PREFIX + actionDefinition,
            description,
            propertyIndex: recordIndex,
            annotationType: lineItemRecord.$Type
        };
        const actionId = lineItemId === 'LineItems' ? 'ToolBarAction' : 'ObjectPageToolBarAction';
        appSchema['definitions'][actionDefinition] = JSON.parse(JSON.stringify(appSchema['definitions'][actionId]));
        appSchema['definitions'][actionDefinition].annotationPath = lineItemPath + '/' + recordIndex;
    }
}
exports.handleActionRecord = handleActionRecord;
function handleLineItemRecord(lineItem, appSchema, columnDefinitionName, entityType, i, oDataServiceAVT) {
    var _a, _b;
    const lineItemId = lineItem['lineItemId'];
    const lineItemRecord = lineItem['lineItemRecord'];
    const lineItemPath = lineItem['lineItemPath'];
    if (lineItemRecord['Target'] && lineItemRecord['Target']['value']) {
        const regex = `@${utils_1.findAlias(common_1.UIVOCABULARY, oDataServiceAVT)}.`;
        lineItemRecord['Target']['value'] = lineItemRecord['Target']['value'].replace(regex, '@');
    }
    const schemaKey = StableIdHelper_1.getStableIdPartFromDataField(lineItemRecord);
    if (schemaKey) {
        appSchema['definitions'][lineItemId]['properties'][schemaKey] = {
            $ref: utils_1.DEFINITION_LINK_PREFIX + columnDefinitionName,
            description: utils_1.getDatafieldDescription(lineItemRecord, entityType),
            // Custom property in schema - for object properties ordering purpose
            propertyIndex: i,
            annotationPath: `${lineItemPath}/${i}`,
            annotationType: lineItemRecord === null || lineItemRecord === void 0 ? void 0 : lineItemRecord.$Type
        };
        if (lineItemRecord.$Type === 'com.sap.vocabularies.UI.v1.DataField') {
            appSchema['definitions'][lineItemId]['properties'][schemaKey].dataType = (_b = (_a = lineItemRecord['Value']) === null || _a === void 0 ? void 0 : _a.$target) === null || _b === void 0 ? void 0 : _b.type.replace('Edm.', '');
        }
    }
}
/**
 * Adds the line item definition, columns and actions to the app schema (for the list report or an object page section comprising a table)
 * @param appSchema - the app specific schema that shall get enhanced
 * @param lineItemAnnotation - the UI.LineItem annotation, comprising all records
 * @param entityType - the entity type as part of the AVT ConverterOutput
 * @param {ConverterOutput} oDataServiceAVT - complete service information, as returned by Annotation Vocabularies Tool
 * @param columnDefinitionName - name of the column definition, i.e. TableColumn or ObjectPageTableColumn
 * @param actionDefinitionName - indicates the prefix for the definition, dpending on the page type
 * @param lineItemId - optional: in case of OP the paramter must be passed to distinguish the OP tables;
 *                      in case of LR or ALP no ID is passed, 'LineItems' is taken then.
 */
function addLineItemsType(appSchema, lineItemAnnotation, entityType, oDataServiceAVT, columnDefinitionName, lineItemId) {
    appSchema['definitions'][columnDefinitionName] = JSON.parse(JSON.stringify(appSchema['definitions']['GenericColumns']['additionalProperties'].anyOf[0]));
    // Add the correct lineItem definition
    lineItemId = lineItemId || 'LineItems';
    const { actions, lineItemPath } = common_1.addCommonLineItemDefinitions(appSchema, lineItemAnnotation, entityType, lineItemId);
    if (lineItemAnnotation) {
        let i = 0;
        lineItemAnnotation.forEach((lineItemRecord) => {
            if (lineItemRecord.$Type === "com.sap.vocabularies.UI.v1.DataFieldForAction" /* DataFieldForAction */ &&
                (lineItemRecord.Inline !== true || lineItemRecord.Determining === true)) {
                handleActionRecord(appSchema, entityType, actions, lineItemPath, lineItemRecord, lineItemId, i);
            }
            else {
                const lineItem = { lineItemRecord: lineItemRecord, lineItemId: lineItemId, lineItemPath: lineItemPath };
                handleLineItemRecord(lineItem, appSchema, columnDefinitionName, entityType, i, oDataServiceAVT);
            }
            i++;
        });
    }
}
exports.addLineItemsType = addLineItemsType;
//# sourceMappingURL=utils.js.map